# HG changeset patch
# Parent 75859e38becc95345d55445ceca31408fec49bed
# User aleth <aleth@instantbird.org>
Clicking the video call button during a call should end the call. Also remove some duplication

diff --git a/im/content/conversation.xml b/im/content/conversation.xml
--- a/im/content/conversation.xml
+++ b/im/content/conversation.xml
@@ -394,17 +394,17 @@
               label: convBundle.GetStringFromName("cancelCall.label"),
               popup: null
             }]);
 
           // Set call timeout to 30 sec.
           const timer = 30;
           this.callTimeout = setTimeout(() => this.endCall(true), timer * 1000);
 
-          // Disable video button on call start.
+          // Disable video button until call actually starts.
           let videoCallButton = this.getElt("videoCallButton");
           if (videoCallButton)
             videoCallButton.disabled = true;
         ]]>
         </body>
       </method>
 
       <method name="onVideoCallOffer">
@@ -464,21 +464,21 @@
                 pc.setLocalDescription(answer, () => {}, () => this.callError("LocalDesc"));
               }, () => this.callError("Answer"));
 
               pc.onicecandidate = event => {
                 if (event.candidate)
                   return;
                 pc.onicecandidate = null;
 
-                if (this._conv)
-                  this._conv.acceptCall(pc.localDescription.sdp);
-                this.getElt("videoCallBox").removeAttribute("hidden");
-                this.getElt("videoCall-splitter").removeAttribute("hidden");
-                this.ongoingCall = true;
+                if (!this._conv)
+                  return;
+
+                this._conv.acceptCall(pc.localDescription.sdp);
+                this.initVideoCall();
               };
             }, () => this.callError("Video"));
           }, () => this.callError("RemoteDesc"));
         ]]>
         </body>
       </method>
 
       <method name="onVideoCallAnswered">
@@ -493,18 +493,33 @@
           clearTimeout(this.callTimeout);
           delete this.callTimeout;
 
           let callWaitNotification = this.getElt("convNotificationBox");
           let notification =  callWaitNotification.getNotificationWithValue("video-call-wait");
           if (notification)
             callWaitNotification.removeNotification(notification);
 
+          this.initVideoCall();
+        ]]>
+        </body>
+      </method>
+
+      <method name="initVideoCall">
+        <body>
+        <![CDATA[
           this.getElt("videoCallBox").removeAttribute("hidden");
           this.getElt("videoCall-splitter").removeAttribute("hidden");
+
+          // Allow using the button to end the call.
+          let videoCallButton = this.getElt("videoCallButton");
+          if (videoCallButton)
+            videoCallButton.removeAttribute("disabled");
+
+          this.ongoingCall = true;
         ]]>
         </body>
       </method>
 
       <method name="endCall">
         <parameter name="aSender"/>
         <body>
         <![CDATA[
@@ -2052,17 +2067,17 @@
           let bundle = Services.strings.createBundle(
             "chrome://instantbird/locale/conversation.properties");
           button.classList.add("videoCallButton");
           button.setAttribute("tooltiptext",
                               bundle.GetStringFromName("videoCallButton.label"));
           button.setAttribute("accesskey",
                               bundle.GetStringFromName("videoCallButton.accesskey"));
           button.setAttribute("anonid", "videoCallButton");
-          button.setAttribute("command", "cmd_startCall");
+          button.setAttribute("command", "cmd_videoCallButton");
           button.setAttribute("hidden", "true");
           let cti = this.getElt("conv-top-info");
           cti.insertBefore(button, cti.firstChild);
           this.updateVideoCallButton();
 
           // Target switcher button.
           let targetSwitcher = document.createElement("toolbarbutton");
           targetSwitcher.setAttribute("disabled", "true");
diff --git a/im/content/instantbird.xul b/im/content/instantbird.xul
--- a/im/content/instantbird.xul
+++ b/im/content/instantbird.xul
@@ -69,19 +69,24 @@
              oncommand="var conv = getTabBrowser().selectedConversation;
                         if (conv) conv.findbar.onFindCommand();"/>
     <command id="cmd_findAgain"
              oncommand="var conv = getTabBrowser().selectedConversation;
                         if (conv) conv.findbar.onFindAgainCommand(true);"/>
     <command id="cmd_findPrevious"
              oncommand="var conv = getTabBrowser().selectedConversation;
                         if (conv) conv.findbar.onFindAgainCommand(false);"/>
-    <command id="cmd_startCall"
+    <command id="cmd_videoCallButton"
              oncommand="var conv = getTabBrowser().selectedConversation;
-                        if (conv) conv.startCall();"/>
+                        if (!conv)
+                          return;
+                        if (conv.ongoingCall)
+                          conv.endCall();
+                        else
+                          conv.startCall();"/>
     <command id="cmd_endCall"
              oncommand="var conv = getTabBrowser().selectedConversation;
                         if (conv) conv.endCall(true);"/>
     <commandset id="editMenuCommands"/>
   </commandset>
 
   <keyset id="conversationsKeys">
     <key id="key_newtab" key="t" modifiers="accel" command="cmd_newtab"/>
